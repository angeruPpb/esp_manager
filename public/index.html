<!DOCTYPE html>
<html>
<head>
    <title>ESP32 OTA Manager</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { 
            font-family: monospace; 
            max-width: 1000px; 
            margin: 50px auto;
            background: #0d1117;
            color: #c9d1d9;
            padding: 20px;
        }
        .card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 20px;
            margin: 20px 0;
        }
        input, button, select {
            padding: 10px;
            margin: 5px;
            border-radius: 6px;
            border: 1px solid #30363d;
            background: #0d1117;
            color: #c9d1d9;
        }
        select {
            width: 100%;
            max-width: 400px;
        }
        button {
            background: #238636;
            border-color: #238636;
            cursor: pointer;
        }
        button:hover { background: #2ea043; }
        button.delete { background: #da3633; border-color: #da3633; }
        button.delete:hover { background: #f85149; }
        .firmware-item, .device-item {
            background: #0d1117;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            border-left: 3px solid #238636;
        }
        .online { border-left-color: #3fb950; }
        .offline { border-left-color: #f85149; }
        code {
            background: #0d1117;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        @media (max-width: 768px) {
            .grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <h1>üîß ESP32 OTA Manager</h1>
    
    <div class="grid">
        <div class="card">
            <h3>üì± Registrar Dispositivo</h3>
            <input type="text" id="deviceName" placeholder="Nombre del dispositivo (ej: ESP32-Cocina)">
            <button onclick="registerDevice()">‚ûï Registrar</button>
            <div id="apiKeyResult" style="margin-top: 10px;"></div>
        </div>

        <div class="card">
            <h3>üì§ Subir Firmware (.bin)</h3>
            <select id="deviceSelect">
                <option value="">Seleccione un dispositivo...</option>
            </select>
            <input type="file" id="firmwareFile" accept=".bin">
            <input type="text" id="version" placeholder="Versi√≥n (ej: 1.0.0)">
            <input type="text" id="description" placeholder="Descripci√≥n">
            <button onclick="uploadFirmware()">Subir</button>
        </div>
    </div>

    <div class="card">
        <h3>üñ•Ô∏è Dispositivos Registrados</h3>
        <button onclick="loadDevices()">üîÑ Recargar</button>
        <div id="devicesList"></div>
    </div>

    <div class="card">
        <h3>üìã Firmwares Disponibles</h3>
        <button onclick="loadFirmwares()">üîÑ Recargar</button>
        <div id="firmwareList"></div>
    </div>

    <script>
        const socket = io();
        let devicesCache = [];

        // ============ CONEXI√ìN WEBSOCKET ============
        socket.on('connect', () => {
            console.log('‚úÖ Conectado al servidor WebSocket');
            loadDevices();
            loadFirmwares();
        });

        socket.on('disconnect', () => {
            console.log('‚ùå Desconectado del servidor WebSocket');
        });

        // ============ DISPOSITIVOS ============
        function registerDevice() {
            const name = document.getElementById('deviceName').value;
            if (!name) {
                alert('Ingresa un nombre para el dispositivo');
                return;
            }

            socket.emit('register_device', { name });
        }

        socket.on('device_registered', (data) => {
            const resultDiv = document.getElementById('apiKeyResult');
            
            if (data.isNew) {
                resultDiv.innerHTML = `
                    <div style="background: #238636; padding: 15px; border-radius: 6px; margin-top: 10px;">
                        <strong>‚úÖ Dispositivo registrado exitosamente</strong><br>
                        <strong>Nombre:</strong> ${data.device.name}<br>
                        <strong>API Key:</strong> <code>${data.device.apiKey}</code><br>
                        <small>‚ö†Ô∏è Guarda esta clave, la necesitar√°s en el ESP32</small>
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div style="background: #1f6feb; padding: 15px; border-radius: 6px; margin-top: 10px;">
                        <strong>‚ÑπÔ∏è Este dispositivo ya estaba registrado</strong><br>
                        <strong>Nombre:</strong> ${data.device.name}<br>
                        <strong>API Key:</strong> <code>${data.device.apiKey}</code><br>
                        <small>üí° Usa la misma API Key que antes</small>
                    </div>
                `;
            }
            
            document.getElementById('deviceName').value = '';
        });

        function loadDevices() {
            socket.emit('get_devices');
        }

        socket.on('devices_list', (devices) => {
            updateDevicesList(devices);
        });

        socket.on('devices_update', (devices) => {
            updateDevicesList(devices);
        });

        function updateDevicesList(devices) {
            devicesCache = devices;

            const select = document.getElementById('deviceSelect');
            select.innerHTML = '<option value="">Seleccione un dispositivo...</option>' +
                devices.map(d => `<option value="${d.id}">${d.name}</option>`).join('');

            const list = document.getElementById('devicesList');
            const now = new Date();

            list.innerHTML = devices.map(d => {
                const lastCheck = new Date(d.lastCheck);
                const diffSeconds = (now - lastCheck) / 1000;
                const isOnline = diffSeconds < 60;
                const status = isOnline ? 'online' : 'offline';

                let updateStatusHTML = '';
                if (d.lastUpdateStatus && d.lastUpdateStatus !== 'none') {
                    const statusIcons = {
                        'success': '‚úÖ Actualizaci√≥n exitosa',
                        'failed': '‚ùå Actualizaci√≥n fallida',
                        'pending': '‚è≥ Actualizaci√≥n pendiente'
                    };
                    const statusColors = {
                        'success': '#3fb950',
                        'failed': '#f85149',
                        'pending': '#d29922'
                    };
                    
                    updateStatusHTML = `
                        <small style="color: ${statusColors[d.lastUpdateStatus]}">
                            ${statusIcons[d.lastUpdateStatus]}
                            ${d.lastUpdateDate ? `(${new Date(d.lastUpdateDate).toLocaleString()})` : ''}
                        </small><br>
                    `;
                }

                return `
                    <div class="device-item ${status}">
                        <strong>${d.name}</strong> 
                        <span style="color: ${isOnline ? '#3fb950' : '#f85149'}">
                            ${isOnline ? 'üü¢ Online' : 'üî¥ Offline'}
                        </span><br>
                        <small>ID: <code>${d.id}</code></small><br>
                        <small>Versi√≥n actual: <code>${d.currentVersion}</code></small><br>
                        ${updateStatusHTML}
                        <small>√öltima consulta: ${lastCheck.toLocaleString()}</small><br>
                        <small>IP: ${d.ipAddress || 'N/A'}</small><br>
                        <small>API Key: <code>${d.apiKey}</code></small><br>
                        <button class="delete" onclick="deleteDevice('${d.id}')">üóëÔ∏è Eliminar</button>
                    </div>
                `;
            }).join('');
        }

        function deleteDevice(id) {
            if (!confirm('¬øEliminar este dispositivo?')) return;
            socket.emit('delete_device', { id });
        }

        // ============ FIRMWARES ============
        async function uploadFirmware() {
            const file = document.getElementById('firmwareFile').files[0];
            const version = document.getElementById('version').value;
            const description = document.getElementById('description').value;
            const deviceId = document.getElementById('deviceSelect').value;

            if (!deviceId) {
                alert('Selecciona un dispositivo');
                return;
            }

            if (!file) {
                alert('Selecciona un archivo .bin');
                return;
            }

            if (!version) {
                alert('Ingresa una versi√≥n');
                return;
            }

            const formData = new FormData();
            formData.append('firmware', file);
            formData.append('version', version);
            formData.append('description', description);
            formData.append('deviceId', deviceId);

            const res = await fetch('/esp/firmware/upload', {
                method: 'POST',
                body: formData
            });

            const data = await res.json();
            alert(`‚úÖ Firmware subido: ${data.firmware.filename}\nURL: ${data.firmware.url}`);
            
            document.getElementById('firmwareFile').value = '';
            document.getElementById('version').value = '';
            document.getElementById('description').value = '';
            document.getElementById('deviceSelect').value = '';
        }

        function loadFirmwares() {
            socket.emit('get_firmwares');
        }

        socket.on('firmwares_list', (firmwares) => {
            updateFirmwaresList(firmwares);
        });

        socket.on('firmwares_update', (firmwares) => {
            updateFirmwaresList(firmwares);
        });

        socket.on('firmware_uploaded', (firmware) => {
            console.log('‚úÖ Nuevo firmware subido:', firmware);
            loadFirmwares();
        });

        function updateFirmwaresList(firmwares) {
            const list = document.getElementById('firmwareList');
            list.innerHTML = firmwares.map(f => {
                const device = devicesCache.find(d => d.id === f.deviceId);
                const deviceName = device ? device.name : 'Desconocido';

                return `
                    <div class="firmware-item">
                        <strong>v${f.version}</strong> - ${f.description}<br>
                        <small>üéØ Dispositivo: <strong>${deviceName}</strong> (ID: ${f.deviceId})</small><br>
                        <small>Archivo: ${f.filename} (${(f.size/1024).toFixed(2)} KB)</small><br>
                        <small>Subido: ${new Date(f.uploadDate).toLocaleString()}</small><br>
                        <small>URL: <code>${f.url}</code></small><br>
                        <button class="delete" onclick="deleteFirmware('${f.id}')">üóëÔ∏è Eliminar</button>
                    </div>
                `;
            }).join('');
        }

        function deleteFirmware(id) {
            if (!confirm('¬øEliminar este firmware?')) return;
            socket.emit('delete_firmware', { id });
        }

        socket.on('device_updated', (data) => {
            console.log('‚úÖ Dispositivo actualizado:', data);
        });

        // Auto-recargar cada 10 segundos (ahora usando WebSocket)
        setInterval(loadDevices, 10000);
    </script>
</body>
</html>